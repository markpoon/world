/**
 * lovely.io 'dnd' module v1.0.1
 *
 * Copyright (C) 2012 Nikolay Nemshilov
 */
Lovely("dnd-1.0.1",["dom-1.2.0"],function(a){var b={},c,Draggable,Droppable,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;return g=this.Lovely.module("core"),c=this.Lovely.module("dom-1.2.0"),y=g.ext,f=g.bind,e=g.Hash,B=g.isString,z=g.isArray,A=g.isObject,d=c.Element,D=function(a,c,d){var e,f,g,h;f=y({},b[a[0].toUpperCase()+a.substr(1)].Options),f=y(f,(new Function("return "+c.attr("data-"+a)))()),f=y(f,d),e=["beforedrag","dragstart","drag","dragend","dragenter","dragleave","drop"];for(g=0,h=e.length;g<h;g++)a=e[g],a in f&&(c.on(a,f[a]),delete f[a]);return f},Draggable={Options:{handle:null,snap:0,axis:null,range:null,dragClass:"dragging",clone:!1,revert:!1,revertDuration:"normal",scroll:!0,scrollSensitivity:32,zIndex:999999999,moveOut:!1},current:null,draggable:function(a){return a===!1?delete this.__draggable:"__draggable"in this||(this.__draggable=C(this,a)),this}},m=0,n=0,k=0,l=0,C=function(a,b){var d,e;return b=D("draggable",a,b),B(b.handle)&&(b.handle=c(b.handle)),z(b.handle)&&(b.handle=b.handle[0]),b.handle=b.handle||a,z(b.snap)?(b.snapX=b.snap[0],b.snapY=b.snap[1]):b.snapX=b.snapY=b.snap||0,b.axisX=(d=b.axis)==="x"||d==="horizontal",b.axisY=(e=b.axis)==="y"||e==="vertical",b},h=function(a,b){var d,e,f;b.ranged=!1;if(e=b.range)b.ranged=!0,f=c(e),f.position&&(d=f.position(),e={x:[d.x,d.x+f.size().x],y:[d.y,d.y+f.size().y]}),A(e)&&("x"in e&&(b.minX=e.x[0],b.maxX=e.x[1]-a.size().x),"y"in e&&(b.minY=e.y[0],b.maxY=e.y[1]-a.size().y))},p=function(a,b){var d,e,f,g;a.type="beforedragstart",b.emit(a),v(),d=b.__draggable,f=b.position(),m=a.pageX-f.x,n=a.pageY-f.y,k=0,l=0,e=b.parent();while(e instanceof c.Element){if(e.style("position")!=="static"){e=e.position(),k=e.x,l=e.y;break}e=e.parent()}g=b.style("width,height"),g.width==="auto"&&(g.width=b.size().x+"px"),g.height==="auto"&&(g.height=b.size().y+"px");if(d.clone||d.revert)d._clone=b.clone().style({visibility:d.clone?"visible":"hidden"}).insertTo(b,"after");return b.style({position:"absolute",zIndex:Draggable.Options.zIndex++,top:f.y-l+"px",left:f.x-k+"px",width:g.x,height:g.y}).addClass(d.dragClass),d.moveOut&&b.insertTo(document.body),d.winScrolls=c(window).scrolls(),d.winSizes=c(window).size(),h(b,d),Draggable.current=b,b.emit("dragstart")},j=function(a,b){var d,e,f,g,h,i,j;return d=b.__draggable,e=a.pageX,f=a.pageY,i=e-m,j=f-n,d.ranged&&(d.minX>i&&(i=d.minX),d.maxX<i&&(i=d.maxX),d.minY>j&&(j=d.minY),d.maxY<j&&(j=d.maxY)),d.scroll&&(g={x:d.winScrolls.x,y:d.winScrolls.y},h=d.scrollSensitivity,f-g.y<h?g.y=f-h:g.y+d.winSizes.y-f<h&&(g.y=f-d.winSizes.y+h),e-g.x<h?g.x=e-h:g.x+d.winSizes.x-e<h&&(g.x=e-d.winSizes.x+h),g.y<0&&(g.y=0),g.x<0&&(g.x=0),(g.y<d.winScrolls.y||g.y>d.winScrolls.y||g.x<d.winScrolls.x||g.x>d.winScrolls.x)&&c(window).scrolls(d.winScrolls=g)),d.snapX&&(i-=i%d.snapX),d.snapY&&(j-=j%d.snapY),d.axisY||(b._.style.left=i-k+"px"),d.axisX||(b._.style.top=j-l+"px"),a.type="drag",b.emit(a)},i=function(a,b){var c;return c=b.__draggable,b.removeClass(c.dragClass),s(a,b),c.revert?o(b,c):Draggable.current=null,a.type="dragend",b.emit(a)},o=function(a,b){var c,d;d=b._clone.position(),c={top:d.y-l+"px",left:d.x-k+"px"},b.revertDuration&&a.animate?a.animate(c,{duration:b.revertDuration,finish:function(){return q(a,b)}}):(a.style(c),q(a,b))},q=function(a,b){return b._clone&&(a.style(b._clone.style("width,height,position,zIndex")),b._clone.replace(a)),Draggable.current=null},Droppable={Options:{accept:"*",overlap:!1,overlapSize:.5,allowClass:"droppable-allow",denyClass:"droppable-deny"},current:null,droppable:function(a){return a===!1?delete this.__droppable:"__droppable"in this||(this.__droppable=D("droppable",this,a),x.push(this)),this}},x=[],v=function(){return c("*[data-droppable]").map("droppable")},t=function(a,b){var c,d,e,f,g,h,i,j,k;h=null,e=a.position(),c=b.position(),d=b.size();for(j=0,k=x.length;j<k;j++){i=x[j];if(u(i,e,c,d)){g=i;break}}if(g&&Droppable.current===null)return f=g.__droppable,r(Draggable.current,g)?g.addClass(f.allowClass):g.addClass(f.denyClass),Droppable.current=g,g.emit("dragenter",{draggable:Draggable.current,droppable:Droppable.current});if(!g&&Droppable.current!==null)return w(),Droppable.current.emit("dragleave",{draggable:Draggable.current,droppable:Droppable.current}),Droppable.current=null},u=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p;h=a.__droppable,g=h.overlapSize,p=c.y,f=c.x,i=f+d.x,e=p+d.y,l=a.position(),n=a.size(),o=l.y,k=l.x,m=k+n.x,j=o+n.y;if(h.overlap===!1)return b.x>k&&b.x<m&&b.y>o&&b.y<j;switch(h.overlap){case"x":case"horizontal":return(p>o&&p<j||e>o&&e<j)&&(f>k&&f<m-n.x*g||i<m&&i>k+n.x*g);case"y":case"vertical":return(f>k&&f<m||i>k&&i<m)&&(p>o&&p<j-n.y*g||e<j&&e>o+n.y*g);default:return(f>k&&f<m-n.x*g||i<m&&i>k+n.x*g)&&(p>o&&p<j-n.y*g||e<j&&e>o+n.y*g)}},r=function(a,b){var d,e,f,g,h,i,j,k;e=b.__droppable;if(e.accept==="*")return!0;g=e.accept,z(g)||(g=[g]);for(h=0,j=g.length;h<j;h++){f=g[h],B(f)&&(f=c(f)),z(f)||(f=[f]);for(i=0,k=f.length;i<k;i++){d=f[i];if(d._===a._)return!0}}return!1},w=function(){var a,b;return b=Droppable.current,a=b.__droppable,b.removeClass(a.allowClass),b.removeClass(a.denyClass)},s=function(a,b){Droppable.current!==null&&(w(),r(b,Droppable.current)&&Droppable.current.emit("drop",{draggable:b,droppable:Droppable.current}))},c(document).on({"mousemove,touchmove":function(a){Draggable.current!==null&&(j(a,Draggable.current),t(a,Draggable.current))},"mouseup,touchend":function(a){Draggable.current!==null&&i(a,Draggable.current)},"mousedown,touchstart":function(a){var b;if(Draggable.current===null){b=a.target;while(b instanceof c.Element){b.attr("data-draggable")!==null&&b.draggable();if("__draggable"in b){a.stop(),p(a,b);break}b=b.parent()}}}}),c(window).on("blur",function(a){Draggable.current!==null&&i(a,Draggable.current)}),d.include({draggable:Draggable.draggable,droppable:Droppable.droppable}),y(b,{version:"1.0.1",Draggable:Draggable,Droppable:Droppable}),b})